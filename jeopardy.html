<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeopardy ‚Äî Trivia Night</title>
  <meta name="theme-color" content="#0c1730" />
  <style>
    :root{--bg:#0c1730;--panel:#0f2347;--text:#dff3ff;--accent:#5ee1ff;--gold:#ffc84a;--mut:#7f8db2;--safe-top:max(12px, env(safe-area-inset-top));}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:radial-gradient(1200px 700px at -10% -10%,#183461 0%,#0c1730 50%,#0a1326 100%);
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      padding-top:calc(var(--safe-top) - 12px);
    }
    .app{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:14px}
    h1{margin:0;font-size:22px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:9px 14px;background:#132b57;color:var(--text);cursor:pointer;font-weight:800;box-shadow:0 6px 16px rgba(0,0,0,.25),inset 0 0 0 1px rgba(255,255,255,.06)}
    .btn.secondary{background:#15294a}
    .btn.success{background:linear-gradient(135deg,#13c7a3,#47f3c9)}
    .card{background:#0f2347;border-radius:18px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.06)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start}
    .section-title{margin:0 0 10px;font-weight:800;opacity:.9}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:12px 0}

    /* --- Board --- */
    .board{display:grid;grid-template-columns:repeat(6,1fr);gap:14px}
    .cell{
      display:grid;place-items:center;height:86px;border-radius:14px;
      background:#15294a; box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
      font-weight:900; font-size:28px; letter-spacing:.5px; color:var(--gold); cursor:pointer; user-select:none;
    }
    .cell.used{background:#0f213f;color:var(--mut);position:relative}
    .cell.used::after{content:"‚úì";position:absolute;right:10px;bottom:10px;opacity:.35;font-size:16px}

    /* --- Teams panel --- */
    .teams{display:grid;grid-template-columns:1fr 40px 1fr;align-items:center;gap:10px}
    .badge{width:140px;height:140px;border-radius:50%;background:#0f213f;margin:auto;display:block;position:relative;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .badge.drop-target{outline:2px solid var(--accent);box-shadow:0 0 0 6px rgba(94,225,255,.15), inset 0 0 0 1px rgba(255,255,255,.06)}
    .team-name{display:flex;gap:8px;align-items:center;margin-top:8px;justify-content:center}
    .team-name input{width:220px;max-width:100%;background:#132b57;border:0;border-radius:10px;padding:8px 10px;color:var(--text)}
    .team-members{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .chip{padding:6px 8px;background:#132b57;border-radius:999px;font-size:13px;display:flex;align-items:center;gap:6px}
    .chip button{border:0;background:#0a1e3c;color:#9ccfff;border-radius:6px;padding:0 6px;cursor:pointer}

    .score{display:grid;gap:8px;margin-top:10px}
    .score-row{display:flex;justify-content:space-between;align-items:center;background:#10254a;padding:8px 10px;border-radius:10px}

    /* Manual adjust */
    .man{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .man .row{gap:6px}
    .num{width:90px;background:#132b57;border-radius:10px;border:0;padding:8px 10px;color:var(--text);font-weight:800}

    /* --- Roster --- */
    .roster{display:grid;gap:8px}
    .person{display:flex;align-items:center;gap:10px;padding:8px;border-radius:12px;background:#10254a;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .avatar{width:28px;height:28px;border-radius:50%;overflow:hidden;display:grid;place-items:center;font-size:13px;font-weight:800;color:#001}
    .person .btn.toggle{margin-left:auto;min-width:110px}

    /* --- Sunny popup --- */
    .siren-btn{
      position:fixed; top:12px; left:12px; z-index:10000;
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border:0; border-radius:12px;
      background:linear-gradient(135deg,#ff3b3b,#ff9e5e);
      color:#001; font-weight:800; cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.25);
    }
    .siren-btn .dot{width:10px;height:10px;border-radius:999px;background:#001;opacity:.9;box-shadow:0 0 0 3px rgba(0,0,0,.15);animation:pulse 1.2s infinite ease-in-out}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:.9}50%{transform:scale(1.3);opacity:.6}}

    #sunnyOverlay{position:fixed; inset:0; z-index:30000; display:none; background:rgba(0,0,0,.7); backdrop-filter:blur(2px)}
    #sunnyOverlay.show{ display:grid; place-items:center }
    .sunny-modal{ width:min(900px,92vw); aspect-ratio:16/9; background:#000; border-radius:14px; position:relative; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.08) }
    .sunny-modal iframe{ width:100%; height:100%; border:0 }
    .sunny-close{ position:absolute; top:8px; right:8px; z-index:2; border:0; border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer; background:#0a1e3c; color:#9ccfff; box-shadow:inset 0 0 0 1px rgba(255,255,255,.12) }

    /* Mobile */
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } .badge{width:120px;height:120px} .cell{height:76px;font-size:24px} }
    @media (max-width:600px){
      .app{ padding:0 14px 84px }
      .siren-btn{ top:auto; left:50%; bottom:12px; transform:translateX(-50%); padding:8px 12px; border-radius:12px; font-weight:800; font-size:14px }
      .cell{height:64px;font-size:22px;border-radius:12px}
      .team-members{flex-wrap:nowrap;overflow-x:auto;gap:8px;justify-content:flex-start}
    }
  </style>
</head>
<body>
  <!-- Emergency button -->
  <button id="emergencyBtn" class="siren-btn" title="Emergency: press if Merlo is falling asleep" aria-label="Emergency: press if Merlo is falling asleep">
    <span class="dot" aria-hidden="true"></span>
    üö® Emergency ‚Äî Wake Merlo!
  </button>

  <!-- Sunny overlay -->
  <div id="sunnyOverlay" aria-hidden="true">
    <div class="sunny-modal" role="dialog" aria-label="Always Sunny Clip">
      <button class="sunny-close" id="sunnyClose" aria-label="Close video">√ó</button>
      <div id="sunnyPlayer" style="width:100%;height:100%"></div>
    </div>
  </div>

  <div class="app">
    <header>
      <div class="row">
        <a href="index.html" class="btn secondary">‚Üê Back to Main</a>
        <button id="newJepBtn" class="btn">New Jeopardy</button>
      </div>
      <h1>Jeopardy Scoreboard</h1>
    </header>

    <div class="grid">
      <!-- LEFT: Board -->
      <section class="card">
        <h3 class="section-title">Board</h3>
        <div id="board" class="board"></div>
        <div class="divider"></div>
        <button id="finalBtn" class="btn success">Final Jeopardy</button>
      </section>

      <!-- RIGHT: Teams / Roster -->
      <aside class="card">
        <h3 class="section-title">Teams</h3>
        <div class="teams">
          <div class="teamA">
            <div id="badgeA" class="badge" title="Drag players here"></div>
            <div class="team-name"><input id="teamAName" value="Team A" /></div>
            <div id="teamAList" class="team-members"></div>
          </div>
          <div style="display:grid;place-items:center;font-weight:900;color:var(--accent)">VS</div>
          <div class="teamB">
            <div id="badgeB" class="badge" title="Drag players here"></div>
            <div class="team-name"><input id="teamBName" value="Team B" /></div>
            <div id="teamBList" class="team-members"></div>
          </div>
        </div>

        <div class="divider"></div>
        <h3 class="section-title">Scoreboard</h3>
        <div id="score" class="score"></div>

        <div class="man">
          <div class="row">
            <button class="btn" id="aMinus">‚àí</button>
            <input id="aDelta" type="number" class="num" value="100" />
            <button class="btn" id="aPlus">+</button>
          </div>
          <div class="row">
            <button class="btn" id="bMinus">‚àí</button>
            <input id="bDelta" type="number" class="num" value="100" />
            <button class="btn" id="bPlus">+</button>
          </div>
        </div>

        <div class="divider"></div>
        <h3 class="section-title">Roster</h3>
        <div id="roster" class="roster"></div>
      </aside>
    </div>
  </div>

  <!-- Tile Modal -->
  <div id="tileOverlay" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);z-index:30000">
    <div class="card" style="width:min(440px,92vw)">
      <h3 id="tileTitle" class="section-title">$400</h3>
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:700;margin-bottom:6px">Which team answered?</div>
          <div class="row">
            <button class="btn" id="tileTeamA">Team A</button>
            <button class="btn" id="tileTeamB">Team B</button>
          </div>
        </div>
        <div>
          <div style="font-weight:700;margin-bottom:6px">Result</div>
          <div class="row">
            <button class="btn success" id="tileRight">Right</button>
            <button class="btn secondary" id="tileWrong">Wrong</button>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end">
        <button id="tileCancel" class="btn secondary">Cancel</button>
        <button id="tileApply" class="btn">Apply</button>
      </div>
    </div>
  </div>

  <!-- Undo Modal -->
  <div id="undoOverlay" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);z-index:30000">
    <div class="card" style="width:min(420px,92vw)">
      <h3 class="section-title" id="undoTitle">Reopen this clue?</h3>
      <p style="opacity:.85;margin-top:0">Reverts the score change and makes the tile available again.</p>
      <div class="row" style="justify-content:flex-end">
        <button id="undoCancel" class="btn secondary">Keep Closed</button>
        <button id="undoConfirm" class="btn">Reopen</button>
      </div>
    </div>
  </div>

  <!-- Final Jeopardy -->
  <div id="finalOverlay" style="position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.7);backdrop-filter:blur(2px);z-index:30000">
    <div class="card" style="width:min(520px,92vw)">
      <h3 class="section-title">Final Jeopardy</h3>
      <div class="row" style="gap:20px;justify-content:space-between">
        <div>
          <div style="opacity:.9;margin-bottom:6px" id="fjAName">Team A</div>
          <input id="fjAWager" type="number" min="0" value="0" class="btn" style="width:160px;background:#132b57" />
          <div class="row" style="margin-top:6px">
            <button id="fjARight" class="btn success">Right</button>
            <button id="fjAWrong" class="btn secondary">Wrong</button>
          </div>
        </div>
        <div>
          <div style="opacity:.9;margin-bottom:6px" id="fjBName">Team B</div>
          <input id="fjBWager" type="number" min="0" value="0" class="btn" style="width:160px;background:#132b57" />
          <div class="row" style="margin-top:6px">
            <button id="fjBRight" class="btn success">Right</button>
            <button id="fjBWrong" class="btn secondary">Wrong</button>
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row" style="justify-content:flex-end">
        <button id="finalClose" class="btn secondary">Close</button>
      </div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    /* ---------- Tiny DOM helpers ---------- */
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const initials = n => n.split(/\s+/).map(s=>s[0]).join('').toUpperCase();

    /* ---------- Always Sunny overlay (same as index) ---------- */
    function buildEmbedUrl(id){
      const params = new URLSearchParams({autoplay:"1", mute:"1", playsinline:"1", modestbranding:"1", rel:"0"});
      return `https://www.youtube.com/embed/${id}?${params.toString()}`;
    }
    const SUNNY_SHORTS = ['2uK7aPgVNLI','JSFOr7ZGG18','wjDFqPBxIkI','ywGHeCD_BZc','skJGJV8QLOY','wMtm5wkMdg8','H7j53N4l3HA','wXk0TWqg3WM','UVIsGSlW2gs','NYpEqCpgsYo','yCZ-5a6GBtE','XCFwkOZzRSM','-ygA9VJEL-s','6rjG0OFvVBg','be8s6Cz4FJw','sxvElyepIBQ','NETjjgCZAdM','tyfnHOqLv0U','fHTNNiRJTxQ','xW9ZybNOq9Q'];
    (function initSunnyPopup(){
      const btn = $('#emergencyBtn'), overlay = $('#sunnyOverlay'), closeBtn = $('#sunnyClose'), mount = $('#sunnyPlayer');
      let ytReady=false, player=null;
      window.onYouTubeIframeAPIReady = function(){ ytReady=true; };
      const randomShortId = ()=> SUNNY_SHORTS[Math.floor(Math.random()*SUNNY_SHORTS.length)];
      function openOverlay(){ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); document.documentElement.style.overflow='hidden'; }
      function closeOverlay(){ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; try{ player&&player.destroy&&player.destroy(); }catch{} player=null; mount.innerHTML=''; }
      function playShort(id){
        if (window.YT && ytReady && typeof YT.Player==='function'){
          mount.innerHTML='';
          player = new YT.Player('sunnyPlayer', { videoId:id, playerVars:{autoplay:1,controls:1,modestbranding:1,rel:0,playsinline:1},
            events:{ onReady:(e)=>{ try{e.target.unMute();e.target.setVolume(100);e.target.playVideo();}catch{} } }});
          return;
        }
        mount.innerHTML = `<iframe src="${buildEmbedUrl(id)}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen referrerpolicy="strict-origin-when-cross-origin" style="width:100%;height:100%;border:0"></iframe>`;
      }
      btn.addEventListener('click', ()=>{ openOverlay(); const id=randomShortId(); playShort(id); });
      closeBtn.addEventListener('click', closeOverlay);
      overlay.addEventListener('click', (e)=>{ if (e.target===overlay) closeOverlay(); });
      document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && overlay.classList.contains('show')) closeOverlay(); });
    })();

    /* ---------- Audio on open ---------- */
    const theme = new Audio('assets/jeopardy_theme.mp3');
    theme.preload = 'auto';
    // Try immediate play; if blocked, start on first user gesture
    theme.play().catch(()=> {
      const kick = ()=>{ theme.play().catch(()=>{}); document.removeEventListener('click', kick, {once:true}); };
      document.addEventListener('click', kick, {once:true});
    });

    /* ---------- State ---------- */
    const VALUES = [200,400,600,800,1000]; // top -> bottom
    let PEOPLE=[], selectedIds=new Set();
    let teamA=[], teamB=[];
    let teamANameVal='Team A', teamBNameVal='Team B';
    let SCORE_A=0, SCORE_B=0;
    let BOARD = {}; // "c-r" => {value, used, team, right}

    /* ---------- Load roster from main app if present ---------- */
    (function restoreFromMain(){
      try{
        const raw = localStorage.getItem('trivia_state');
        if(!raw) return;
        const s = JSON.parse(raw);
        PEOPLE = s.PEOPLE || [];
        selectedIds = new Set(s.selectedIds || PEOPLE.map(p=>p.id));
        teamANameVal = s.teamAName || teamANameVal;
        teamBNameVal = s.teamBName || teamBNameVal;
      }catch{}
    })();

    /* ---------- Save/restore jeopardy state ---------- */
    function saveLocal(){
      const state = {
        jeopardy: { BOARD, SCORE_A, SCORE_B, teamA: teamA.map(p=>p.id), teamB: teamB.map(p=>p.id), teamAName: teamANameVal, teamBName: teamBNameVal },
        PEOPLE, selectedIds:[...selectedIds]
      };
      localStorage.setItem('jeopardy_state', JSON.stringify(state));
    }
    function restoreLocal(){
      try{
        const raw = localStorage.getItem('jeopardy_state');
        if(!raw) return;
        const s = JSON.parse(raw);
        if (s.PEOPLE && !PEOPLE.length) PEOPLE = s.PEOPLE;
        if (s.selectedIds) selectedIds = new Set(s.selectedIds);
        const j = s.jeopardy || {};
        BOARD = j.BOARD || {};
        SCORE_A = j.SCORE_A|0; SCORE_B = j.SCORE_B|0;
        teamA = (j.teamA||[]).map(id=>PEOPLE.find(p=>p.id===id)).filter(Boolean);
        teamB = (j.teamB||[]).map(id=>PEOPLE.find(p=>p.id===id)).filter(Boolean);
        teamANameVal = j.teamAName || teamANameVal;
        teamBNameVal = j.teamBName || teamBNameVal;
      }catch{}
    }

    /* ---------- Roster ---------- */
    function renderRoster(){
      const wrap=$('#roster'); wrap.innerHTML='';
      PEOPLE.forEach(p=>{
        const row=document.createElement('div'); row.className='person'; row.draggable=true; row.dataset.id=p.id; row.title='Drag onto a team badge';
        const av=document.createElement('div'); av.className='avatar'; av.style.background=p.color||'#9ad8ff';
        if (p.photo){ const img=new Image(); img.src=p.photo; img.alt=p.name; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.draggable=false; av.appendChild(img); }
        else av.textContent=initials(p.name);
        const name=document.createElement('div'); name.textContent=p.name; name.style.flex='1';
        const togg=document.createElement('button'); const on=selectedIds.has(p.id);
        togg.className='btn toggle'+(on?' active':''); togg.textContent = on?'On Wheel':'Off';
        togg.addEventListener('click',()=>{ if(on){selectedIds.delete(p.id);}else{selectedIds.add(p.id);} renderRoster(); });
        row.appendChild(av); row.appendChild(name); row.appendChild(togg);
        row.addEventListener('dragstart',e=>{ e.dataTransfer.setData('text/plain', p.id); });
        wrap.appendChild(row);
      });
    }

    /* ---------- Drag to team badges ---------- */
    function addToTeam(letter, person){
      if (!person) return;
      if (teamA.some(x=>x.id===person.id) || teamB.some(x=>x.id===person.id)) return;
      if (letter==='A') teamA.push(person); else teamB.push(person);
      renderTeams(); saveLocal();
    }
    [$('#badgeA'), $('#badgeB')].forEach((b,ix)=>{
      b.addEventListener('dragover', e=>{ e.preventDefault(); b.classList.add('drop-target'); });
      b.addEventListener('dragleave', ()=> b.classList.remove('drop-target'));
      b.addEventListener('drop', e=>{
        e.preventDefault(); b.classList.remove('drop-target');
        const id=e.dataTransfer.getData('text/plain'); const p=PEOPLE.find(x=>x.id===id); if(!p) return;
        teamA = teamA.filter(x=>x.id!==id); teamB = teamB.filter(x=>x.id!==id);
        addToTeam(ix===0?'A':'B', p);
      });
    });

    function removeFromTeam(letter, id){
      if (letter==='A') teamA = teamA.filter(p=>p.id!==id); else teamB = teamB.filter(p=>p.id!==id);
      renderTeams(); saveLocal();
    }

    function renderBadges(){
      const draw = (canvas, team)=>{
        canvas.innerHTML='';
        const c = document.createElement('canvas'); const size=140, R=62, cx=size/2, cy=size/2;
        c.width=size; c.height=size; const ctx=c.getContext('2d');
        ctx.fillStyle='#0e1f42'; ctx.beginPath(); ctx.arc(cx,cy,R+10,0,Math.PI*2); ctx.fill();
        const n=Math.max(1,Math.min(4,team.length||1)); const span=(2*Math.PI)/n;
        for(let i=0;i<n;i++){
          const a0=-Math.PI/2 + i*span, a1=-Math.PI/2 + (i+1)*span;
          ctx.save(); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,a0,a1,false); ctx.closePath(); ctx.clip();
          ctx.fillStyle=team[i]?.color||'#9ad8ff'; ctx.fillRect(0,0,size,size); ctx.restore();
          const mid=(a0+a1)/2, rr=44;
          ctx.fillStyle='#0a1326'; ctx.font='bold 28px ui-sans-serif,system-ui,Segoe UI,Roboto';
          ctx.textAlign='center'; ctx.textBaseline='middle';
          ctx.fillText(team[i]?initials(team[i].name):'', cx+Math.cos(mid)*rr, cy+Math.sin(mid)*rr);
        }
        ctx.strokeStyle='rgba(255,255,255,.85)'; ctx.lineWidth=6; ctx.beginPath(); ctx.arc(cx,cy,R+10,0,Math.PI*2); ctx.stroke();
        canvas.appendChild(c);
      };
      draw($('#badgeA'), teamA); draw($('#badgeB'), teamB);
    }

    function renderTeams(){
      renderBadges();
      $('#teamAName').value = teamANameVal; $('#teamBName').value = teamBNameVal;
      $('#teamAList').innerHTML = teamA.map(p=>`<span class="chip">${p.name}<button onclick="removeFromTeam('A','${p.id}')">‚úï</button></span>`).join('');
      $('#teamBList').innerHTML = teamB.map(p=>`<span class="chip">${p.name}<button onclick="removeFromTeam('B','${p.id}')">‚úï</button></span>`).join('');
      $('#score').innerHTML = `
        <div class="score-row"><div id="sbA">${teamANameVal}</div><div id="sa">${SCORE_A}</div></div>
        <div class="score-row"><div id="sbB">${teamBNameVal}</div><div id="sb">${SCORE_B}</div></div>
      `;
      $('#fjAName').textContent = teamANameVal;
      $('#fjBName').textContent = teamBNameVal;
    }
    window.removeFromTeam = removeFromTeam;

    $('#teamAName').addEventListener('input', ()=>{ teamANameVal=$('#teamAName').value||'Team A'; renderTeams(); saveLocal(); });
    $('#teamBName').addEventListener('input', ()=>{ teamBNameVal=$('#teamBName').value||'Team B'; renderTeams(); saveLocal(); });

    /* ---------- Manual score adjust ---------- */
    function clampInt(v){ v=parseInt(v,10); return Number.isFinite(v)?v:0; }
    $('#aPlus').addEventListener('click', ()=>{ SCORE_A += clampInt($('#aDelta').value); renderTeams(); saveLocal(); });
    $('#aMinus').addEventListener('click', ()=>{ SCORE_A = Math.max(-99999, SCORE_A - clampInt($('#aDelta').value)); renderTeams(); saveLocal(); });
    $('#bPlus').addEventListener('click', ()=>{ SCORE_B += clampInt($('#bDelta').value); renderTeams(); saveLocal(); });
    $('#bMinus').addEventListener('click', ()=>{ SCORE_B = Math.max(-99999, SCORE_B - clampInt($('#bDelta').value)); renderTeams(); saveLocal(); });

    /* ---------- Board ---------- */
    function buildBoard(){
      const boardEl = $('#board'); boardEl.innerHTML='';
      for (let c=0;c<6;c++){
        for (let r=0;r<5;r++){
          const val = VALUES[r];                 // 200 -> 1000 top -> bottom
          const key = `${c}-${r}`;
          if (!BOARD[key]) BOARD[key] = { value: val, used:false, team:null, right:null };
          const cell = document.createElement('div');
          cell.className = 'cell' + (BOARD[key].used?' used':'');
          cell.textContent = val;
          cell.dataset.key = key;
          cell.addEventListener('click', ()=> onTileClick(key));
          boardEl.appendChild(cell);
        }
      }
    }

    let _pendingKey=null, _pendingTeam='A', _pendingRight=true;
    function onTileClick(key){
      const t = BOARD[key];
      if (!t.used){ openTileModal(key); }
      else { openUndoModal(key); }
    }
    function openTileModal(key){
      _pendingKey=key; _pendingTeam='A'; _pendingRight=true;
      $('#tileTitle').textContent = `$${BOARD[key].value}`;
      $('#tileOverlay').style.display='grid';
    }
    function closeTileModal(){ $('#tileOverlay').style.display='none'; }

    function openUndoModal(key){
      _pendingKey=key;
      $('#undoTitle').textContent = `Reopen $${BOARD[key].value}?`;
      $('#undoOverlay').style.display='grid';
    }
    function closeUndoModal(){ $('#undoOverlay').style.display='none'; }

    $('#tileTeamA').addEventListener('click', ()=> _pendingTeam='A');
    $('#tileTeamB').addEventListener('click', ()=> _pendingTeam='B');
    $('#tileRight').addEventListener('click', ()=> _pendingRight=true);
    $('#tileWrong').addEventListener('click', ()=> _pendingRight=false);
    $('#tileCancel').addEventListener('click', closeTileModal);
    $('#tileApply').addEventListener('click', ()=>{
      const key=_pendingKey; if (!key) return;
      const t=BOARD[key]; if (t.used) { closeTileModal(); return; }
      const sign = _pendingRight ? 1 : -1;
      if (_pendingTeam==='A') SCORE_A += sign * t.value; else SCORE_B += sign * t.value;
      t.used=true; t.team=_pendingTeam; t.right=_pendingRight;
      const cell = document.querySelector(`.cell[data-key="${key}"]`); if (cell) cell.classList.add('used');
      renderTeams(); saveLocal(); closeTileModal();
    });

    $('#undoCancel').addEventListener('click', closeUndoModal);
    $('#undoConfirm').addEventListener('click', ()=>{
      const key=_pendingKey; if (!key) return;
      const t=BOARD[key]; if (!t.used){ closeUndoModal(); return; }
      const sign = t.right ? 1 : -1;
      if (t.team==='A') SCORE_A -= sign * t.value; else SCORE_B -= sign * t.value;
      t.used=false; t.team=null; t.right=null;
      const cell = document.querySelector(`.cell[data-key="${key}"]`); if (cell) cell.classList.remove('used');
      renderTeams(); saveLocal(); closeUndoModal();
    });

    /* ---------- Final Jeopardy ---------- */
    function openFinal(){ $('#finalOverlay').style.display='grid'; }
    function closeFinal(){ $('#finalOverlay').style.display='none'; }
    $('#finalBtn').addEventListener('click', openFinal);
    $('#finalClose').addEventListener('click', closeFinal);
    function applyWager(team, right){
      const input = team==='A' ? $('#fjAWager') : $('#fjBWager');
      const val = Math.max(0, parseInt(input.value||'0',10));
      if (team==='A') SCORE_A += right? val : -val; else SCORE_B += right? val : -val;
      renderTeams(); saveLocal();
    }
    $('#fjARight').addEventListener('click', ()=>applyWager('A',true));
    $('#fjAWrong').addEventListener('click', ()=>applyWager('A',false));
    $('#fjBRight').addEventListener('click', ()=>applyWager('B',true));
    $('#fjBWrong').addEventListener('click', ()=>applyWager('B',false));

    /* ---------- New Jeopardy reset ---------- */
    $('#newJepBtn').addEventListener('click', ()=>{
      if(!confirm('Start a NEW Jeopardy game? This resets the board and scores (teams kept).')) return;
      BOARD={}; SCORE_A=0; SCORE_B=0;
      buildBoard(); renderTeams(); saveLocal();
    });

    /* ---------- Init ---------- */
    function init(){
      restoreLocal();
      buildBoard();
      // mark used cells from saved state
      Object.entries(BOARD).forEach(([key,t])=>{ if (t.used){ const c=document.querySelector(`.cell[data-key="${key}"]`); if (c) c.classList.add('used'); }});
      renderRoster();
      renderTeams();
    }
    init();
  </script>
</body>
</html>

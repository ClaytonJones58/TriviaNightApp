<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="apple-mobile-web-app-title" content="Trivia Night">
  <meta name="theme-color" content="#0c1730">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trivia Night</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <style>
    :root{--bg:#0c1730;--panel:#0f2347;--text:#dff3ff;--accent:#5ee1ff;--safe-top:max(12px, env(safe-area-inset-top))}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1200px 700px at -10% -10%,#183461 0%,#0c1730 50%,#0a1326 100%);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      padding-top:calc(var(--safe-top) - 12px);
    }
    .app{max-width:1200px;margin:28px auto;padding:0 20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:10px}
    h1{margin:0;font-size:24px}
    .grid{display:grid;grid-template-columns:390px 1fr 320px;gap:16px;align-items:start}
    .card{background:#0f2347;border-radius:18px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.06)}
    .section-title{margin:0 0 10px;font-weight:700;opacity:.9}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:9px 14px;background:#132b57;
      color:var(--text);cursor:pointer;font-weight:600;
      box-shadow:0 6px 16px rgba(0,0,0,.25),inset 0 0 0 1px rgba(255,255,255,.06)
    }
    .btn.secondary{background:#15294a}
    .btn.success{background:linear-gradient(135deg,#13c7a3,#47f3c9)}
    .btn.toggle{background:#15294a;outline:2px solid transparent}
    .btn.toggle.active{outline-color:var(--accent);box-shadow:0 0 0 4px rgba(94,225,255,.15)}
    .faint{opacity:.7}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:10px 0}

    /* Emergency button */
    .siren-btn{
      position:fixed; top:var(--safe-top); left:12px; z-index:10000;
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border:0; border-radius:12px;
      background:linear-gradient(135deg,#ff3b3b,#ff9e5e);
      color:#001; font-weight:800; cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.35), inset 0 0 0 2px rgba(255,255,255,.25);
    }
    .siren-btn .dot{
      width:10px; height:10px; border-radius:999px; background:#001; opacity:.9;
      box-shadow:0 0 0 3px rgba(0,0,0,.15);
      animation:pulse 1.2s infinite ease-in-out;
    }
    @keyframes pulse{ 0%,100%{transform:scale(1);opacity:.9} 50%{transform:scale(1.3);opacity:.6} }

    /* YouTube overlay */
    #sunnyOverlay{ position:fixed; inset:0; z-index:10001; display:none; background:rgba(0,0,0,.7); backdrop-filter:blur(2px); }
    #sunnyOverlay.show{ display:grid; place-items:center; }
    .sunny-modal{
      width:min(900px,92vw); aspect-ratio:16/9; background:#000; border-radius:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.6), inset 0 0 0 1px rgba(255,255,255,.08);
      position:relative; overflow:hidden;
    }
    .sunny-modal iframe{ width:100%; height:100%; border:0; }
    .sunny-close{
      position:absolute; top:8px; right:8px; z-index:2;
      border:0; border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer;
      background:#0a1e3c; color:#9ccfff; box-shadow:inset 0 0 0 1px rgba(255,255,255,.12);
    }
    .sunny-close:hover{ background:#102852; }

    /* Wheel */
    .wheel-wrap{display:grid;gap:12px;grid-template-rows:auto 1fr auto}
    .wheel-area{position:relative;display:grid;place-items:center}
    .pointer{position:absolute;top:8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:20px solid var(--accent)}
    .rotor{ position:relative; width:320px; height:320px; transform-origin:50% 50%; will-change:transform; }
    #wheelCanvas{ width:100%; height:100%; display:block; }
    .labels{position:absolute;inset:0}
    .bubble{
      position:absolute;width:56px;height:56px;border-radius:50%;
      display:grid;place-items:center;font-weight:800;color:#0a1326;background:#dff3ff;
      box-shadow:0 6px 12px rgba(0,0,0,.35);transform:translate(-50%,-50%)
    }

    /* Roster */
    .roster{display:grid;gap:8px}
    .person{
      display:flex;align-items:center;gap:10px;padding:8px;border-radius:12px;
      background:#10254a;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)
    }
    .avatar{
      width:28px;height:28px;border-radius:50%;display:grid;place-items:center;
      font-size:13px;font-weight:700;color:#001; overflow:hidden;
    }
    .addperson{display:flex;gap:8px;margin-top:10px}
    .addperson input[type="text"]{flex:1;min-width:120px;background:#132b57;border:0;padding:8px 10px;border-radius:10px;color:var(--text)}
    .addperson input[type="color"]{width:42px;height:42px;border:0;background:#132b57;border-radius:10px;padding:0}
    .icon-del{
      border:0;background:#0a1e3c;color:#9ccfff;width:28px;height:28px;border-radius:8px;
      display:grid;place-items:center;font-weight:800;cursor:pointer;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)
    }
    .icon-del:hover{background:#102852}

    /* Matchup */
    .teams{display:grid;grid-template-columns:1fr 40px 1fr;align-items:center}
    .badge{width:150px;height:150px;margin:auto}
    /* Fix mobile overlap: make the badge canvas obey the container size */
.badge { position: relative; }
.badge canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;            /* remove extra inline spacing */
}

    .team-name{display:flex;gap:8px;align-items:center;margin-top:8px}
    .team-name input{background:#132b57;border:0;padding:8px 10px;border-radius:10px;color:var(--text);width:180px}
    .team-members{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
    .chip{padding:6px 8px;background:#132b57;border-radius:999px;font-size:13px;display:flex;align-items:center;gap:6px}
    .chip button{border:0;background:#0a1e3c;color:#9ccfff;border-radius:6px;padding:0 6px;cursor:pointer}

    /* Games */
    .games{display:grid;gap:10px}
    .game-list{display:grid;gap:8px}
    .game a{
      color:var(--text);text-decoration:none;background:#132b57;padding:10px 12px;border-radius:10px;
      display:flex;align-items:center;justify-content:space-between;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)
    }
    .glabel{display:flex;gap:10px;align-items:center}
    .ico{width:22px;height:22px;border-radius:6px;background:#0d1f3e;display:grid;place-items:center;font-size:13px}

    /* Scoreboard */
    .score{display:grid;gap:10px}
    .score-row{display:flex;justify-content:space-between;align-items:center;background:#10254a;padding:8px 10px;border-radius:10px}

    /* Tracker */
    #tracker{display:flex;flex-direction:column;gap:10px}
    .track-card{position:relative;background:#10254a;border-radius:10px;padding:10px 12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
    .track-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .track-title{font-weight:700}
    .tr-remove{border:0;background:#0a1e3c;color:#9ccfff;width:26px;height:26px;border-radius:8px;display:grid;place-items:center;font-weight:800;cursor:pointer;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
    .tr-remove:hover{background:#102852}
    .pick-row{display:flex;flex-direction:row;gap:10px;margin-top:10px;flex-wrap:nowrap}
    .pick{flex:1 1 0;min-width:0;max-width:none;padding:10px 14px;border-radius:10px;background:#132b57;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);cursor:pointer;font:600 14px ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;letter-spacing:.2px;color:#dff3ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pick.active{outline:2px solid var(--accent);box-shadow:0 0 0 4px rgba(94,225,255,.15), inset 0 0 0 1px rgba(255,255,255,.06)}
    .manual-points{margin-top:6px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.12);display:flex;flex-direction:column;gap:8px}
    .mp-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:nowrap}
    .mp-side{flex:1;min-width:0;display:flex;align-items:center;gap:8px}
    .mp-side strong{max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font:700 14px ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;color:#dff3ff}
    .mp-btn{border:0;background:#0a1e3c;color:#9ccfff;width:28px;height:28px;border-radius:8px;display:grid;place-items:center;font-weight:800;cursor:pointer;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
    .mp-btn:hover{background:#102852}
    .mp-val{min-width:22px;text-align:center;font-weight:700}

    /* Player panel */
   .player-panel{
  position: fixed;              /* was absolute */
  z-index: 10002;               /* above app UI, below the overlay tweak below */
  width:600px;
  background:#10254a;
  border-radius:16px;
  padding:16px;
  box-shadow:0 18px 48px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.08);
  display:none;
  gap:16px
}
.player-panel.show{display:grid}

/* keep the wake video overlay on top of *everything* */
#sunnyOverlay{ z-index: 10010; }

    .player-panel.show{display:grid}
    .pp-head{display:grid;grid-template-columns:160px 1fr 36px;gap:16px;align-items:center}
    .pp-photo{width:160px;height:160px;border-radius:14px;overflow:hidden;background:#132b57;display:grid;place-items:center;font-weight:800;color:#dff3ff;font-size:36px}
    .pp-photo img{width:100%;height:100%;object-fit:cover}
    .pp-name{font-weight:800;font-size:26px;line-height:1.2}
    .pp-sub{opacity:.8;font-size:14px;margin-top:6px}
    .pp-close{border:0;background:#0a1e3c;color:#9ccfff;width:36px;height:36px;border-radius:10px;display:grid;place-items:center;font-weight:800;cursor:pointer;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}
    .pp-close:hover{background:#102852}
    .pp-controls{margin-top:6px;display:grid;grid-template-columns:auto 1fr;align-items:center;gap:12px}
    .pp-label{font-size:13px;opacity:.85}
    #ppColor{width:64px;height:46px;border:0;border-radius:10px;padding:0;background:#132b57;cursor:pointer;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}

    /* Layout fixes */
    .teamA,.teamB{ display:flex; flex-direction:column; align-items:center; }
    .badge{ margin-bottom:10px; }
    .team-name{ width:100%; max-width:260px; margin-top:10px; display:flex; flex-direction:column; gap:6px; }
    .team-name input{ width:100%; max-width:260px; }
    .team-members{ margin-top:10px; max-width:260px; display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
    .team-members::-webkit-scrollbar{ height:6px; } .team-members::-webkit-scrollbar-thumb{ background:rgba(255,255,255,0.3); border-radius:3px; }

    /* Responsive */
    @media (max-width:980px){ .grid{ grid-template-columns:1fr; } aside.card{ order:3 } }
    @media (max-width:960px){ .grid{ grid-template-columns:1fr; gap:14px } header{ flex-wrap:wrap; gap:8px } }
    @media (max-width:900px){
      .app{padding:0 12px}
      .grid{grid-template-columns:1fr; gap:12px}
      header .row{width:100%; overflow-x:auto; gap:8px; padding-bottom:6px}
      header .btn{flex:0 0 auto}
      .rotor{ width:min(78vw,420px); height:min(78vw,420px); margin:6px auto 0; }
      .sunny-modal{width:92vw; aspect-ratio:9/16}
      .team-name{flex-direction:column; align-items:stretch}
      .team-members{justify-content:flex-start}
      .chip{display:inline-flex; margin-bottom:6px}
      .badge{width:120px; height:120px}
    }
    @media (max-width:600px){
      .app{ padding:0 14px 84px; padding-top:64px; }
      .siren-btn{ top:12px; left:12px; bottom:auto; transform:none; }
      .card{ padding:14px; border-radius:14px }
      .btn{ padding:8px 12px }
      .rotor{ width:260px; height:260px }
      .badge{ width:120px; height:120px }
      .team-members{ gap:8px; justify-content:flex-start; flex-wrap:nowrap; overflow-x:auto; }
      .chip{ font-size:12px; padding:6px 8px }
      .teams{ grid-template-columns:1fr 32px 1fr; align-items:start; row-gap:10px }
      .team-name{ margin-top:6px }
    }
    @media (max-width:480px){
      h1{font-size:20px}
      .btn{padding:10px 12px; border-radius:10px}
      .badge{width:100px; height:100px}
      .rotor{width:86vw; height:86vw}
    }
  </style>
</head>
<body>
  <!-- Emergency button -->
  <button id="emergencyBtn" class="siren-btn" title="Emergency: press if Merlo is falling asleep" aria-label="Emergency: press if Merlo is falling asleep">
    <span class="dot" aria-hidden="true"></span> ðŸš¨ Emergency â€” Wake Merlo!
  </button>

  <!-- YouTube overlay -->
  <div id="sunnyOverlay" aria-hidden="true">
    <div class="sunny-modal" role="dialog" aria-label="Always Sunny Clip">
      <button class="sunny-close" id="sunnyClose" aria-label="Close video">Ã—</button>
      <div id="sunnyPlayer" style="width:100%;height:100%"></div>
    </div>
  </div>

  <div class="app">
    <header>
      <h1>ðŸŒ€ Trivia Night</h1>
      <div class="row">
        <button id="newGameBtn" class="btn">New Game</button>
        <button id="resetBtn" class="btn secondary">Reset</button>
        <button id="clearTeamsBtn" class="btn secondary">Clear Teams</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card wheel-wrap">
        <div class="row">
          <button id="modeNormal" class="btn">Normal Spin</button>
          <button id="modeFoF" class="btn secondary">Friend or Foe</button>
          <span id="modeState" class="faint"></span>
        </div>

        <div class="wheel-area">
          <div class="pointer"></div>
          <div id="rotor" class="rotor">
            <canvas id="wheelCanvas" width="320" height="320"></canvas>
            <div id="labels" class="labels"></div>
          </div>
        </div>

        <div class="row">
          <button id="spinBtn" class="btn success">SPIN</button>
          <button id="friendBtn" class="btn toggle" style="display:none">Friend</button>
          <button id="foeBtn" class="btn toggle" style="display:none">Foe</button>
        </div>

        <div class="divider"></div>
        <h3 class="section-title">Roster</h3>
        <div id="roster" class="roster"></div>
        <div class="addperson">
          <input id="newName" type="text" placeholder="Add player nameâ€¦" />
          <input id="newColor" type="color" value="#6ee7b7" />
          <button id="addBtn" class="btn">Add</button>
        </div>
        <div class="row" style="margin-top:8px">
          <label class="faint">Format:</label>
          <select id="formatSel" class="btn" style="padding-right:28px">
            <option value="2v2" selected>2 vs 2</option>
            <option value="2v1">2 vs 1</option>
            <option value="3v3">3 vs 3</option>
            <option value="3v2">3 vs 2</option>
            <option value="auto">Auto balance</option>
          </select>
        </div>
      </section>

      <!-- MIDDLE -->
      <section class="card">
        <h3 class="section-title">Matchup</h3>
        <div class="teams">
          <div class="teamA">
            <div id="badgeA" class="badge"></div>
            <div class="team-name"><label class="faint">Name</label><input id="teamAName" value="Team A"></div>
            <div id="teamAList" class="team-members"></div>
          </div>
          <div class="vs" style="display:grid;place-items:center;font-weight:800;color:var(--accent)">VS</div>
          <div class="teamB">
            <div id="badgeB" class="badge"></div>
            <div class="team-name"><label class="faint">Name</label><input id="teamBName" value="Team B"></div>
            <div id="teamBList" class="team-members"></div>
          </div>
        </div>

        <div class="divider"></div>
        <h3 class="section-title">Games</h3>
        <div class="games">
          <div class="row">
            <button id="randomFavBtn" class="btn">Pick Random (Favorites)</button>
            <button id="randomAllBtn" class="btn secondary">Pick Random (All)</button>
          </div>
          <div class="game-list" id="favList"></div>
          <details><summary>More games â–¾</summary>
            <div class="game-list" id="moreList" style="margin-top:8px"></div>
          </details>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h3 class="section-title">Scoreboard</h3>
        <div id="score" class="score"></div>

        <div class="divider" style="margin:14px 0"></div>
        <h3 class="section-title">Game Tracker</h3>
        <div id="tracker" class="games" style="gap:10px"></div>
      </aside>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    /* ---------- YouTube wake-up overlay ---------- */
    const SUNNY_SHORTS = ['2uK7aPgVNLI','JSFOr7ZGG18','wjDFqPBxIkI','ywGHeCD_BZc','skJGJV8QLOY','wMtm5wkMdg8','H7j53N4l3HA','wXk0TWqg3WM','UVIsGSlW2gs','NYpEqCpgsYo','yCZ-5a6GBtE','XCFwkOZzRSM','-ygA9VJEL-s','6rjG0OFvVBg','be8s6Cz4FJw','sxvElyepIBQ','NETjjgCZAdM','tyfnHOqLv0U','fHTNNiRJTxQ','xW9ZybNOq9Q','2QWcLVQex1E','u2HE4fBrDlY','VfdBMYixD8k','BTsbkDmn_Mw','NeqAI2u6xPE','Qjh7qSVhPII','zMazJ54cY34','AUG8FyjX-e0','0PvJOrQOlnE','SyFhi2vdyMI','_47Tdm-V1Yo','2-IreehHQN8','HMR0kXuF9_8','X9qeeiQTB9k'];
    function buildEmbedUrl(id){ const p=new URLSearchParams({autoplay:"1",mute:"1",playsinline:"1",modestbranding:"1",rel:"0"}); return `https://www.youtube.com/embed/${id}?${p.toString()}`; }
    (function(){
      const btn=document.getElementById('emergencyBtn');
      const overlay=document.getElementById('sunnyOverlay');
      const closeBtn=document.getElementById('sunnyClose');
      const mount=document.getElementById('sunnyPlayer');
      let ytReady=false, player=null;
      window.onYouTubeIframeAPIReady=function(){ ytReady=true; };
      const toShortId=(s)=>{ if(!s) return null; let m=String(s).match(/\/shorts\/([a-zA-Z0-9_-]{6,})/); if(m) return m[1]; m=String(s).match(/[?&]v=([a-zA-Z0-9_-]{6,})/); if(m) return m[1]; return String(s); };
      const randomShortId=()=> SUNNY_SHORTS.length ? toShortId(SUNNY_SHORTS[Math.floor(Math.random()*SUNNY_SHORTS.length)]) : null;
      const open=()=>{ overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false'); document.documentElement.style.overflow='hidden'; }
      const close=()=>{ overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); document.documentElement.style.overflow=''; try{player&&player.destroy&&player.destroy()}catch{} player=null; mount.innerHTML='' }
      function playShort(id){
        if(window.YT && ytReady && typeof YT.Player==='function'){
          mount.innerHTML='';
          player=new YT.Player('sunnyPlayer',{videoId:id,playerVars:{autoplay:1,controls:1,modestbranding:1,rel:0,playsinline:1},
            events:{ onReady:(e)=>{ try{e.target.unMute()}catch{} try{e.target.setVolume(100)}catch{} try{e.target.playVideo()}catch{} } }});
          return;
        }
        mount.innerHTML = `<iframe src="${buildEmbedUrl(id)}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen referrerpolicy="strict-origin-when-cross-origin" style="width:100%;height:100%;border:0"></iframe>`;
      }
      btn.addEventListener('click',()=>{
        const id=randomShortId(); open();
        if(!id){ mount.innerHTML='<div style="display:grid;place-items:center;height:100%;color:#fff;font:16px system-ui">Add some Shorts IDs.</div>'; return; }
        if(window.YT && ytReady && typeof YT.Player==='function'){ playShort(id); return; }
        mount.innerHTML=`<iframe src="${buildEmbedUrl(id)}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen referrerpolicy="strict-origin-when-cross-origin" style="width:100%;height:100%;border:0"></iframe>`;
        const wait=()=>{ if(window.YT && ytReady && typeof YT.Player==='function') playShort(id); else requestAnimationFrame(wait); };
        requestAnimationFrame(wait);
      });
      closeBtn.addEventListener('click',close);
      overlay.addEventListener('click',(e)=>{ if(e.target===overlay) close(); });
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && overlay.classList.contains('show')) close(); });
    })();
  </script>

  <script>
    /* ---------- Data ---------- */
    const DEFAULT_PEOPLE = [
      { id:'clay',  name:'Clay',     color:'#59e1ff', photo:'assets/players/TrivPic_Clay.png' },
      { id:'merlo', name:'Merlo',    color:'#31d0aa', photo:'assets/players/TrivPic_Merlo.png' },
      { id:'lindz', name:'Lindz',    color:'#ff8a5b', photo:'assets/players/TrivPic_Lindz.png' },
      { id:'danny', name:'Danny',    color:'#8b5cf6', photo:'assets/players/TrivPic_Danny.png' },
      { id:'will',  name:'Will',     color:'#9ca3af', photo:'assets/players/TrivPic_Will.png' },
      { id:'ben',   name:'Ben',      color:'#ffd166', photo:'assets/players/TrivPic_Ben.jpg' },
      { id:'rj',    name:'RJ',       color:'#93c5fd', photo:'assets/players/TrivPic_RJ.png' },
      { id:'sher',  name:'Sherlock', color:'#f472b6', photo:'assets/players/TrivPic_Sherlock.png' },
      { id:'kelly', name:'Kelly',    color:'#6ee7b7', photo:'assets/players/TrivPic_Kelly.png' }
    ];
    const DEFAULT_IDS = new Set(DEFAULT_PEOPLE.map(p=>p.id));

    const FAVORITES = [
      {icon:'ðŸŸ©',title:'Wordle',url:'https://www.nytimes.com/games/wordle/index.html'},
      {icon:'ðŸŽµ',title:'Bandle',url:'https://bandle.app/'},
      {icon:'ðŸ§©',title:'Connections',url:'https://www.nytimes.com/games/connections'},
      {icon:'ðŸ§ ',title:'Daily Dozen',url:'https://www.jomboymedia.com/daily-dozen'},
      {icon:'ðŸ“°',title:'NYT Mini',url:'https://www.nytimes.com/crossword'}
    ];
    const MORE_GAMES = [
      {title:'Framed',url:'https://framed.wtf/'},
      {title:'Movie Grid',url:'https://www.moviedle.app/'},
      {title:'GeoGuessr',url:'https://www.geoguessr.com/'},
      {title:'Flagle',url:'https://flagle.io/'}
    ];

    /* ---------- State ---------- */
    let PEOPLE, selectedIds, wheelIds, mode, chooser, fofChoice, teamA, teamB, nextTeam, teamANameVal, teamBNameVal, savedFormat;
    let TRACKED_GAMES = [];
    let MANUAL_A = 0, MANUAL_B = 0;

    let allowAutoFill = false;
    let _autoFillTimer = null;

    restoreState();

    /* ---------- DOM ---------- */
    const rotor = document.getElementById('rotor');
    const labelsEl = document.getElementById('labels');
    const spinBtn = document.getElementById('spinBtn');
    const friendBtn = document.getElementById('friendBtn');
    const foeBtn = document.getElementById('foeBtn');
    const modeNormal = document.getElementById('modeNormal');
    const modeFoF = document.getElementById('modeFoF');
    const modeState = document.getElementById('modeState');
    const rosterEl = document.getElementById('roster');
    const formatSel = document.getElementById('formatSel');
    const teamAList = document.getElementById('teamAList');
    const teamBList = document.getElementById('teamBList');
    const badgeA = document.getElementById('badgeA');
    const badgeB = document.getElementById('badgeB');
    const teamAName = document.getElementById('teamAName');
    const teamBName = document.getElementById('teamBName');
    const scoreEl = document.getElementById('score');
    const newNameEl = document.getElementById('newName');
    const newColorEl = document.getElementById('newColor');
    const addBtn = document.getElementById('addBtn');

    /* ---- Canvas helpers ---- */
    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    const _imgCache = new Map();
    function loadImage(src){
      return new Promise((res,rej)=>{
        if(_imgCache.has(src)) return res(_imgCache.get(src));
        const im=new Image();
        im.onload=()=>{ _imgCache.set(src,im); res(im); };
        im.onerror=(e)=>{ console.error('âŒ Failed to load',src,e); rej(e); };
        im.src=src;
      });
    }
    function drawImageCover(ctx, img, cx, cy, diam){
      const w=img.width, h=img.height;
      const scale=Math.max(diam/w, diam/h);
      const sw=w*scale, sh=h*scale;
      const sx=(sw-diam)/2, sy=(sh-diam)/2;
      const off=document.createElement('canvas'); off.width=off.height=diam;
      off.getContext('2d').drawImage(img,-sx,-sy,sw,sh);
      ctx.drawImage(off,cx-diam/2,cy-diam/2);
    }

    /* ---- Responsive wheel sizing (single source of truth) ---- */
    let _resizeQueued = false;
    function sizeWheel(){
      if (window._spinning) return;
      const rotorEl = document.getElementById('rotor');
      const area = document.querySelector('.wheel-area');
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      const css = Math.round(rotorEl.clientWidth || 320);
      if (!css) return;

      const clearance = 24;
      area.style.height = (css + clearance) + 'px';
      area.style.minHeight = (css + clearance) + 'px';

      canvas.width = Math.floor(css * dpr);
      canvas.height = Math.floor(css * dpr);
      canvas.style.width = css + 'px';
      canvas.style.height = css + 'px';

      ctx.setTransform(dpr,0,0,dpr,0,0);
      drawWheel();
    }
    function safeSizeWheel(){ if (window._spinning) { _resizeQueued = true; return; } sizeWheel(); }
    window.addEventListener('resize', safeSizeWheel);
    window.addEventListener('orientationchange', safeSizeWheel);
    rotor.addEventListener('transitionend',(e)=>{ if(e.propertyName!=='transform') return; if(_resizeQueued){ _resizeQueued=false; sizeWheel(); } });

    /* ---- Arc helpers ---- */
    const BORDER_THICK = 26;
    const NAME_PAD_DEG = 6;
    function ringSegmentPath(ctx,cx,cy,rO,rI,a0,a1){ ctx.beginPath(); ctx.arc(cx,cy,rO,a0,a1,false); ctx.arc(cx,cy,rI,a1,a0,true); ctx.closePath(); }
    function drawArcText(ctx,text,cx,cy,r,a0,a1){
      if(!text) return;
      const pad = NAME_PAD_DEG*Math.PI/180;
      const span = Math.max(0,(a1-a0)-2*pad);
      if(span<=0) return;
      ctx.save();
      ctx.font='bold 18px ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial';
      ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#dff3ff';
      const baseWidth=ctx.measureText(text).width;
      const maxArc=r*span;
      if(baseWidth>maxArc){
        const scale=Math.max(0.75,maxArc/baseWidth);
        const size=Math.floor(18*scale);
        ctx.font=`bold ${size}px ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial`;
      }
      const widths=[...text].map(ch=>ctx.measureText(ch).width);
      const total=widths.reduce((a,b)=>a+b,0);
      const start=a0+pad+(span-total/r)/2;
      ctx.strokeStyle='rgba(10,19,38,.9)'; ctx.lineWidth=3;
      let acc=0;
      for(let i=0;i<text.length;i++){
        const cw=widths[i];
        const angle=start+(acc+cw/2)/r;
        ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle+Math.PI/2);
        ctx.strokeText(text[i],0,-r); ctx.fillText(text[i],0,-r);
        ctx.restore(); acc+=cw;
      }
      ctx.restore();
    }

    /* ---- Drag â†’ badges ---- */
    [badgeA,badgeB].forEach(b=>{
      b.addEventListener('dragover',e=>{ e.preventDefault(); b.classList.add('drop-target'); });
      b.addEventListener('dragleave',()=> b.classList.remove('drop-target'));
      b.addEventListener('drop',e=>{
        e.preventDefault(); b.classList.remove('drop-target');
        const id=e.dataTransfer.getData('text/plain');
        const person=byId(id); if(!person) return;
        teamA=teamA.filter(p=>p.id!==id); teamB=teamB.filter(p=>p.id!==id);
        if(b===badgeA) addToTeam('A',person); else addToTeam('B',person);
        allowAutoFill=true; autoFillIfDetermined(); allowAutoFill=false;
        syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState();
      });
    });

    /* ---- Helpers ---- */
    const byId=id=>PEOPLE.find(p=>p.id===id);
    const initials=n=>n.split(/\s+/).map(s=>s[0]).join('').toUpperCase();
    const uid=()=> 'p'+Math.random().toString(36).slice(2,8);
    function syncWheelFromSelected(){
      const assigned=new Set([...teamA.map(p=>p.id),...teamB.map(p=>p.id)]);
      wheelIds=[...selectedIds].filter(id=>!assigned.has(id));
    }

    /* ---- Format helpers ---- */
    function targetSizes(){
      const n=[...selectedIds].length, v=formatSel.value||'2v2';
      if(v==='2v2') return [2,2];
      if(v==='2v1') return [2,1];
      if(v==='3v3') return [3,3];
      if(v==='3v2') return [3,2];
      return [Math.ceil(n/2),Math.floor(n/2)];
    }
    const remaining=()=>{ const [A,B]=targetSizes(); return [A-teamA.length,B-teamB.length]; };
    function addToTeam(letter, person){
      if (teamA.some(x=>x.id===person.id) || teamB.some(x=>x.id===person.id)) return;
      const [A,B]=targetSizes();
      if (letter==='A' && teamA.length<A) teamA.push(person);
      else if (letter==='B' && teamB.length<B) teamB.push(person);
      saveState();
    }

    /* ---- Roster ---- */
    function renderRoster(){
      rosterEl.innerHTML="";
      PEOPLE.forEach(p=>{
        const row=document.createElement('div'); row.className='person'; row.draggable=true; row.dataset.id=p.id; row.title='Drag onto a team badge';
        const av=document.createElement('div'); av.className='avatar'; av.style.background=p.color||'#132b57';
        if(p.photo){ const img=document.createElement('img'); img.src=p.photo; img.alt=p.name; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.draggable=false; av.appendChild(img); }
        else { av.textContent=initials(p.name); }
        const name=document.createElement('div'); name.textContent=p.name; name.style.flex='1';
        const toggle=document.createElement('button'); const isSelected=selectedIds.has(p.id);
        toggle.className='btn toggle'+(isSelected?' active':''); toggle.textContent=isSelected?'On Wheel':'Off';
        toggle.addEventListener('click',(e)=>{
          e.stopPropagation();
          if(selectedIds.has(p.id)){ selectedIds.delete(p.id); wheelIds=wheelIds.filter(id=>id!==p.id); }
          else { selectedIds.add(p.id); if(!teamA.some(x=>x.id===p.id)&&!teamB.some(x=>x.id===p.id)) wheelIds.push(p.id); }
          saveState(); syncWheelFromSelected(); drawWheel(); renderRoster();
        });
        let delBtn=null;
        if(!DEFAULT_IDS.has(p.id)){
          delBtn=document.createElement('button'); delBtn.className='icon-del'; delBtn.textContent='Ã—'; delBtn.title='Remove from roster';
          delBtn.addEventListener('click',(e)=>{ e.stopPropagation(); removePerson(p.id); });
        }
        row.addEventListener('dragstart',(e)=>{ e.dataTransfer.setData('text/plain',p.id); PlayerPanel.close(); });
        row.addEventListener('click',(e)=>{ if(e.target.closest('button')) return; PlayerPanel.open(p,row); });
        row.appendChild(av); row.appendChild(name); row.appendChild(toggle); if(delBtn) row.appendChild(delBtn);
        rosterEl.appendChild(row);
      });
    }
    function removePerson(id){
      teamA=teamA.filter(p=>p.id!==id); teamB=teamB.filter(p=>p.id!==id);
      selectedIds.delete(id); wheelIds=wheelIds.filter(x=>x!==id);
      if(chooser && chooser.id===id){ chooser=null; fofChoice=null; setFoFUI(false); lockSpin(false); modeState.textContent=''; }
      PEOPLE=PEOPLE.filter(p=>p.id!==id);
      saveState(); syncWheelFromSelected(); drawWheel(); updateMatchupUI(); renderRoster();
    }

    /* ---- Rotor / canvas drawing ---- */
    function resetRotor(){
      if(window._spinning) return;
      rotor.style.transition='none'; rotor.style.transform='rotate(0deg)'; void rotor.offsetHeight; rotor.style.transition='';
    }
    function drawRadialPhoto(ctx,img,cx,cy,R,a0,a1){
      const mid=(a0+a1)/2;
      const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;
      const scale=Math.max((2*R)/iw,(2*R)/ih);
      const dw=iw*scale, dh=ih*scale;
      const lift=R*0.80;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(mid+Math.PI/2); ctx.drawImage(img,-dw/2,-dh+lift,dw,dh); ctx.restore();
    }
    let _renderToken=0;
    function drawWheel(){
      resetRotor(); labelsEl.innerHTML='';
      if(wheelIds.length===0) syncWheelFromSelected();
      const ids=wheelIds.slice(); const n=ids.length;
      const cssSize=parseInt(getComputedStyle(canvas).width)||320;
      const R=cssSize/2, cx=R, cy=R;

      ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.restore();

      if(!n){
        const token=++_renderToken;
        labelsEl.innerHTML='';
        rotor.style.transition='none'; rotor.style.transform='rotate(0deg)'; void rotor.offsetHeight; rotor.style.transition='';
        loadImage('assets/players/TrivPic_Rosie.png').then(img=>{
          if(token!==_renderToken) return;
          ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height);
          ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.closePath(); ctx.clip();
          drawImageCover(ctx,img,cx,cy,R*2); ctx.restore();
        }).catch(()=>{});
        return;
      }

      const step = (2*Math.PI)/n;
      const arcs = ids.map((id,i)=>({ id, p:byId(id), a0:-Math.PI/2+i*step, a1:-Math.PI/2+(i+1)*step }));
      const token=++_renderToken;

      function paintSlice(p,a0,a1){
        ctx.save(); ctx.globalCompositeOperation='source-over';
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,a0,a1,false); ctx.closePath(); ctx.clip();
        ctx.fillStyle=p.color||'#3b82f6'; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.restore();
        if(n>1){ ctx.save(); ctx.strokeStyle='rgba(10,19,38,.35)'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+R*Math.cos(a1), cy+R*Math.sin(a1)); ctx.stroke(); ctx.restore(); }
      }
      arcs.forEach(({p,a0,a1})=>paintSlice(p,a0,a1));
      const loads = arcs.map(({p,a0,a1})=>{
        if(!p.photo) return Promise.resolve();
        return loadImage(p.photo).then(img=>{
          if(token!==_renderToken) return;
          ctx.save(); ctx.globalCompositeOperation='source-over';
          ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,a0,a1,false); ctx.closePath(); ctx.clip();
          if(n===1){ drawImageCover(ctx,img,cx,cy,R*2); } else { drawRadialPhoto(ctx,img,cx,cy,R,a0,a1); }
          ctx.restore();
          if(n>1){ ctx.save(); ctx.strokeStyle='rgba(10,19,38,.35)'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+R*Math.cos(a1), cy+R*Math.sin(a1)); ctx.stroke(); ctx.restore(); }
        }).catch(()=>{});
      });

      function paintRimsAndNamesAll(){
        const rOuter=R, rInner=R-BORDER_THICK;
        ctx.save(); ctx.globalCompositeOperation='source-over';
        arcs.forEach(({p,a0,a1})=>{
          ringSegmentPath(ctx,cx,cy,rOuter,rInner,a0,a1);
          ctx.fillStyle=p.color||'#3b82f6'; ctx.fill();
          ctx.strokeStyle='rgba(10,19,38,.65)'; ctx.lineWidth=2;
          ctx.beginPath(); ctx.arc(cx,cy,rOuter-1,a0,a1,false); ctx.stroke();
          ctx.beginPath(); ctx.arc(cx,cy,rInner+1,a0,a1,false); ctx.stroke();
          const rText=rInner+(BORDER_THICK/2)-2;
          if(n===1){
            const midTop=-Math.PI/2; const span=(140*Math.PI)/180; const pad=(6*Math.PI)/180; const usable=Math.max(0,span-2*pad);
            ctx.save(); ctx.font='bold 18px ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#dff3ff';
            const base=ctx.measureText(p.name).width; const maxArc=rText*usable;
            if(base>maxArc){ const sc=Math.max(0.75,maxArc/base); const sz=Math.floor(18*sc); ctx.font=`bold ${sz}px ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial`; }
            const widths=[...p.name].map(ch=>ctx.measureText(ch).width);
            const total=widths.reduce((a,b)=>a+b,0); const start=midTop-(total/rText)/2;
            ctx.strokeStyle='rgba(10,19,38,.9)'; ctx.lineWidth=3;
            let acc=0; for(let i=0;i<p.name.length;i++){ const cw=widths[i]; const angle=start+(acc+cw/2)/rText;
              ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle+Math.PI/2); ctx.strokeText(p.name[i],0,-rText); ctx.fillText(p.name[i],0,-rText); ctx.restore(); acc+=cw;
            }
            ctx.restore();
          } else {
            drawArcText(ctx,p.name,cx,cy,rText,a0,a1);
          }
        });
        ctx.restore();
      }
      Promise.allSettled(loads).then(()=>{ if(token!==_renderToken) return; paintRimsAndNamesAll(); });
    }

    /* ---- Spin ---- */
    function spin(){
      if(wheelIds.length===0 || window._spinning || window._spinLocked) return;
      const ids=wheelIds.slice(); const slices=ids.length; const sliceDeg=360/slices;
      const plannedIdx=Math.floor(Math.random()*slices);
      const fullTurns=4+Math.floor(Math.random()*3);
      const centerDeg=plannedIdx*sliceDeg+sliceDeg/2+0.001;
      const targetDeg=fullTurns*360+centerDeg;
      window._spinning=true;
      rotor.style.transition='transform 2200ms cubic-bezier(.2,1,.2,1)';
      rotor.style.transform=`rotate(-${targetDeg}deg)`;
      const onEnd=(ev)=>{
        if(ev.propertyName!=='transform') return;
        rotor.removeEventListener('transitionend',onEnd);
        window._spinning=false;
        onPick(ids[plannedIdx]);
      };
      rotor.addEventListener('transitionend',onEnd,{once:true});
    }
    document.getElementById('spinBtn').addEventListener('click',spin);
    rotor.addEventListener('click',spin);

    /* ---- Badges ---- */
    function renderBadgeSVG(container, team){
      const size=150, R=62, cx=size/2, cy=size/2;
      const can=document.createElement('canvas'); can.width=size; can.height=size; const c=can.getContext('2d');
      const wedge=(a0,a1)=>{ const p=new Path2D(); p.moveTo(cx,cy); p.arc(cx,cy,R,a0,a1,false); p.closePath(); return p; };
      const drawInitials=(person,a0,a1)=>{ const mid=(a0+a1)/2; const th=(a1-a0); const rr=Math.min(52,Math.max(38,(2*R*Math.sin(th/2))/(3*(th/2)))); const tx=cx+Math.cos(mid)*rr; const ty=cy+Math.sin(mid)*rr; c.fillStyle='#0a1326'; c.font='bold 34px ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial'; c.textAlign='center'; c.textBaseline='middle'; c.fillText(initials(person.name),tx,ty); };
      c.fillStyle='#0e1f42'; c.beginPath(); c.arc(cx,cy,R+10,0,Math.PI*2); c.fill();
      const n=Math.min(team.length,4);
      if(n>0){
        const span=(2*Math.PI)/n;
        for(let i=0;i<n;i++){
          const person=team[i]; const a0=-Math.PI/2+i*span; const a1=-Math.PI/2+(i+1)*span; const path=wedge(a0,a1);
          c.save(); c.clip(path); c.fillStyle=person?.color||'#9ad8ff'; c.fillRect(0,0,size,size); c.restore();
          drawInitials(person,a0,a1);
          if(person?.photo){ loadImage(person.photo).then(img=>{ c.save(); c.clip(path); drawImageCover(c,img,cx,cy,R*2); c.restore(); }).catch(()=>{}); }
        }
        if(n===2){ const d=R*Math.SQRT1_2; c.strokeStyle='white'; c.lineWidth=6; c.beginPath(); c.moveTo(cx-d,cy-d); c.lineTo(cx+d,cy+d); c.stroke(); }
        else if(n>=3){ c.strokeStyle='rgba(255,255,255,.85)'; c.lineWidth=4; for(let k=0;k<n;k++){ const ang=-Math.PI/2+k*span; c.beginPath(); c.moveTo(cx,cy); c.lineTo(cx+Math.cos(ang)*R, cy+Math.sin(ang)*R); c.stroke(); } }
      }
      c.strokeStyle='rgba(255,255,255,.85)'; c.lineWidth=6; c.beginPath(); c.arc(cx,cy,R+10,0,Math.PI*2); c.stroke();
      container.innerHTML=''; container.appendChild(can);
    }
    function renderScore(){
      const aWins=TRACKED_GAMES.filter(g=>g.winner==='A').length + (MANUAL_A|0);
      const bWins=TRACKED_GAMES.filter(g=>g.winner==='B').length + (MANUAL_B|0);
      scoreEl.innerHTML = `
        <div class="score-row"><div id="sbA">${teamANameVal||'Team A'}</div><div class="faint">${aWins}</div></div>
        <div class="score-row"><div id="sbB">${teamBNameVal||'Team B'}</div><div class="faint">${bWins}</div></div>
      `;
    }
    function updateMatchupUI(){
      teamAList.innerHTML=teamA.map(p=>`<span class="chip">${p.name}<button class="rem" data-team="A" data-id="${p.id}">âœ•</button></span>`).join('');
      teamBList.innerHTML=teamB.map(p=>`<span class="chip">${p.name}<button class="rem" data-team="B" data-id="${p.id}">âœ•</button></span>`).join('');
      renderBadgeSVG(badgeA,teamA); renderBadgeSVG(badgeB,teamB);
      renderScore(); autoFillIfDetermined();
    }
    document.addEventListener('click',(e)=>{
      const btn=e.target.closest('button.rem'); if(!btn) return;
      const {team,id}=btn.dataset;
      if(team==='A') teamA=teamA.filter(p=>p.id!==id); else teamB=teamB.filter(p=>p.id!==id);
      if(selectedIds.has(id) && !wheelIds.includes(id)) wheelIds.push(id);
      allowAutoFill=false; syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState();
    });

    /* ---- FoF UI ---- */
    let spinLocked=false;
    function setFoFUI(show){ friendBtn.style.display=show?'inline-block':'none'; foeBtn.style.display=show?'inline-block':'none'; if(!show){ friendBtn.classList.remove('active'); foeBtn.classList.remove('active'); } }
    function lockSpin(lock){ spinLocked=lock; window._spinLocked=lock; spinBtn.disabled=lock; }
    friendBtn.addEventListener('click',()=>{ if(chooser){ fofChoice='friend'; friendBtn.classList.add('active'); foeBtn.classList.remove('active'); lockSpin(false); modeState.textContent=`${chooser.name} chose FRIEND`; saveState(); }});
    foeBtn.addEventListener('click',()=>{ if(chooser){ fofChoice='foe'; foeBtn.classList.add('active'); friendBtn.classList.remove('active'); lockSpin(false); modeState.textContent=`${chooser.name} chose FOE`; saveState(); }});

    /* ---- Auto-fill ---- */
    function autoFillIfDetermined(startDelayMs=3000, stepDelayMs=1200){
      if(!allowAutoFill) return;
      if(_autoFillTimer){ clearTimeout(_autoFillTimer); _autoFillTimer=null; }
      _autoFillTimer=setTimeout(()=>{
        _autoFillTimer=null;
        const [A,B]=targetSizes(); const rA=A-teamA.length, rB=B-teamB.length;
        const leftIds=[...wheelIds];
        if(leftIds.length===0){ allowAutoFill=false; return; }
        const pushSeq=(ids,team)=>{ ids.forEach((id,i)=>{ setTimeout(()=>{ const p=byId(id); if(!p) return; wheelIds=wheelIds.filter(x=>x!==id); addToTeam(team,p); syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState(); }, i*stepDelayMs); }); };
        if(rA===0 && leftIds.length>0){ allowAutoFill=false; pushSeq(leftIds,'B'); return; }
        if(rB===0 && leftIds.length>0){ allowAutoFill=false; pushSeq(leftIds,'A'); return; }
        if(leftIds.length===1 && (rA===1)!==(rB===1)){ allowAutoFill=false; pushSeq(leftIds, (rA===1)?'A':'B'); return; }
        allowAutoFill=false;
      }, startDelayMs);
    }
    function assignAlternating(person){
      const [A,B]=targetSizes(); const rA=A-teamA.length, rB=B-teamB.length;
      let team=nextTeam; if(team==='A' && rA<=0 && rB>0) team='B'; if(team==='B' && rB<=0 && rA>0) team='A';
      addToTeam(team,person); nextTeam = (team==='A')?'B':'A';
      const left=wheelIds.length; const rA2=A-teamA.length, rB2=B-teamB.length;
      allowAutoFill = (rA2===0||rB2===0) || (left===1 && ((rA2===1)!==(rB2===1)));
      autoFillIfDetermined();
    }

    function onPick(id){
      wheelIds=wheelIds.filter(x=>x!==id); drawWheel();
      const person=byId(id); if(!person){ updateMatchupUI(); saveState(); return; }
      if(mode==='fof'){
        if(!chooser){
          chooser=person; fofChoice=null; setFoFUI(true); lockSpin(true); modeState.textContent=`${person.name} â€” choose Friend or Foe`; saveState(); return;
        }
        const teamOf=(p)=> teamA.some(x=>x.id===p.id)?'A' : teamB.some(x=>x.id===p.id)?'B' : null;
        const [rA,rB]=remaining(); let chooserTeam=teamOf(chooser); if(!chooserTeam) chooserTeam=(rA>=rB)?'A':'B';
        const otherTeam=(chooserTeam==='A')?'B':'A';
        addToTeam(chooserTeam, chooser);
        const choice=fofChoice||'friend';
        if(choice==='friend') addToTeam(chooserTeam, person); else addToTeam(otherTeam, person);
        allowAutoFill=true; autoFillIfDetermined(); allowAutoFill=false;
        if(wheelIds.length>0){
          chooser=person; fofChoice=null; setFoFUI(true); lockSpin(true); modeState.textContent=`${person.name} â€” choose Friend or Foe`;
        } else {
          chooser=null; fofChoice=null; setFoFUI(false); lockSpin(false); modeState.textContent='';
        }
        syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState(); return;
      }
      // Normal
      assignAlternating(person); syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState();
    }

    /* ---- Games + Tracker ---- */
    function renderGames(){
      const fav=document.getElementById('favList'), more=document.getElementById('moreList');
      fav.innerHTML=FAVORITES.map(g=>`<div class="game">
        <a href="${g.url}" data-gameid="${g.title.toLowerCase().replace(/\s+/g,'-')}" data-title="${g.title}" class="game-link" target="_blank">
          <span class="glabel"><span class="ico">${g.icon}</span><span>${g.title}</span></span><span>â†—</span>
        </a></div>`).join('');
      more.innerHTML=MORE_GAMES.map(g=>`<div class="game">
        <a href="${g.url}" data-gameid="${g.title.toLowerCase().replace(/\s+/g,'-')}" data-title="${g.title}" class="game-link" target="_blank">
          <span class="glabel"><span class="ico">ðŸŽ®</span><span>${g.title}</span></span><span>â†—</span>
        </a></div>`).join('');
      function attach(container){
        container.querySelectorAll('a.game-link').forEach(a=>{
          a.addEventListener('click',(e)=>{
            e.preventDefault();
            const id=a.dataset.gameid, title=a.dataset.title, url=a.getAttribute('href');
            addGameToTracker({id,title,url});
            window.open(url,'_blank','noopener,noreferrer');
          });
        });
      }
      attach(fav); attach(more);
    }
    function upsertTrackedGame(game){
      const existing=TRACKED_GAMES.find(g=>g.id===game.id);
      if(existing) return existing;
      const row={ id:game.id, title:game.title, url:game.url, winner:null, shown:true };
      TRACKED_GAMES.push(row); return row;
    }
    function addGameToTracker(game){ upsertTrackedGame(game); renderGameTracker(); saveState(); }
    function renderGameTracker(){
      const wrap=document.getElementById('tracker'); if(!wrap) return;
      const nameA=teamAName.value||'Team A', nameB=teamBName.value||'Team B';
      if(TRACKED_GAMES.length===0){
        wrap.innerHTML='<div class="note">No games logged yet. Click a game to add it here.</div>';
      } else {
        wrap.innerHTML=TRACKED_GAMES.map(g=>{
          const aSel=g.winner==='A'?'active':'', bSel=g.winner==='B'?'active':'';
          return `<div class="track-card" data-id="${g.id}">
            <div class="track-top"><div class="track-title">${g.title}</div><button class="tr-remove" title="Remove" data-action="remove">Ã—</button></div>
            <div class="pick-row">
              <button class="pick ${aSel}" data-action="win" data-team="A">${nameA}</button>
              <button class="pick ${bSel}" data-action="win" data-team="B">${nameB}</button>
            </div>
          </div>`;
        }).join('');
      }
      const manual=document.createElement('div'); manual.className='manual-points';
      manual.innerHTML=`
        <div class="mp-row">
          <div class="mp-side"><strong>${nameA}</strong>
            <button class="mp-btn" data-mp="A" data-delta="-1">âˆ’</button>
            <span class="mp-val" id="mpA">${MANUAL_A|0}</span>
            <button class="mp-btn" data-mp="A" data-delta="1">+</button>
          </div>
          <div class="mp-side"><strong>${nameB}</strong>
            <button class="mp-btn" data-mp="B" data-delta="-1">âˆ’</button>
            <span class="mp-val" id="mpB">${MANUAL_B|0}</span>
            <button class="mp-btn" data-mp="B" data-delta="1">+</button>
          </div>
        </div>`;
      wrap.appendChild(manual);

      wrap.querySelectorAll('.track-card').forEach(card=>{
        const id=card.dataset.id; const g=TRACKED_GAMES.find(x=>x.id===id); if(!g) return;
        card.querySelector('[data-action="remove"]').addEventListener('click',()=>{ TRACKED_GAMES=TRACKED_GAMES.filter(x=>x.id!==g.id); renderScore(); renderGameTracker(); saveState(); });
        card.querySelectorAll('[data-action="win"]').forEach(btn=>{
          btn.addEventListener('click',()=>{ const team=btn.dataset.team; g.winner=(g.winner===team)?null:team; renderScore(); renderGameTracker(); saveState(); });
        });
      });
      wrap.querySelectorAll('.mp-btn').forEach(b=>{
        b.addEventListener('click',()=>{ const who=b.dataset.mp; const delta=parseInt(b.dataset.delta,10);
          if(who==='A') MANUAL_A=Math.max(0,(MANUAL_A|0)+delta); else MANUAL_B=Math.max(0,(MANUAL_B|0)+delta);
          renderScore(); renderGameTracker(); saveState();
        });
      });
    }

    /* ---- Save / Restore ---- */
    function saveState(){
      const state={
        PEOPLE,
        selectedIds:[...selectedIds],
        wheelIds,mode,chooser:chooser?.id||null,fofChoice,
        teamA:teamA.map(p=>p.id), teamB:teamB.map(p=>p.id),
        nextTeam,format:formatSel.value,
        teamAName:teamAName.value, teamBName:teamBName.value,
        trackedGames:TRACKED_GAMES, manualA:MANUAL_A, manualB:MANUAL_B
      };
      localStorage.setItem('trivia_state',JSON.stringify(state));
    }
    function restoreState(){
      const raw=localStorage.getItem('trivia_state');
      if(!raw){
        PEOPLE=[...DEFAULT_PEOPLE];
        selectedIds=new Set(PEOPLE.slice(0,4).map(p=>p.id));
        wheelIds=[...selectedIds];
        mode='normal'; chooser=null; fofChoice=null;
        teamA=[]; teamB=[]; nextTeam='A';
        teamANameVal='Team A'; teamBNameVal='Team B'; savedFormat='2v2';
        return;
      }
      try{
        const s=JSON.parse(raw);
        PEOPLE=s.PEOPLE||[...DEFAULT_PEOPLE];
        selectedIds=new Set(s.selectedIds||PEOPLE.slice(0,4).map(p=>p.id));
        wheelIds=s.wheelIds||[...selectedIds];
        mode=s.mode||'normal';
        chooser=s.chooser?PEOPLE.find(p=>p.id===s.chooser):null;
        fofChoice=s.fofChoice||null;
        teamA=(s.teamA||[]).map(id=>PEOPLE.find(p=>p.id===id)).filter(Boolean);
        teamB=(s.teamB||[]).map(id=>PEOPLE.find(p=>p.id===id)).filter(Boolean);
        nextTeam=s.nextTeam||'A';
        teamANameVal=s.teamAName||'Team A';
        teamBNameVal=s.teamBName||'Team B';
        savedFormat=s.format||'2v2';
        TRACKED_GAMES = Array.isArray(s.trackedGames)? s.trackedGames : [];
        MANUAL_A = Number.isFinite(s.manualA)? s.manualA : 0;
        MANUAL_B = Number.isFinite(s.manualB)? s.manualB : 0;
      }catch{
        PEOPLE=[...DEFAULT_PEOPLE];
        selectedIds=new Set(PEOPLE.slice(0,4).map(p=>p.id));
        wheelIds=[...selectedIds];
        mode='normal'; chooser=null; fofChoice=null;
        teamA=[]; teamB=[]; nextTeam='A';
        teamANameVal='Team A'; teamBNameVal='Team B'; savedFormat='2v2';
      }
      const defaultsById=Object.fromEntries(DEFAULT_PEOPLE.map(p=>[p.id,p]));
      PEOPLE=PEOPLE.map(p=>({ ...defaultsById[p.id], ...p }));
    }

    /* ---- Controls ---- */
    function addGuest(){
      const name=newNameEl.value.trim(); if(!name){ newNameEl.focus(); return; }
      const color=newColorEl.value||'#6ee7b7';
      const person={ id:uid(), name, color, photo:'' };
      PEOPLE.push(person);
      selectedIds.add(person.id); wheelIds.push(person.id);
      newNameEl.value='';
      renderRoster(); syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState();
    }
    addBtn.addEventListener('click',addGuest);
    newNameEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter') addGuest(); });

    document.getElementById('resetBtn').addEventListener('click',()=>{
      resetRotor(); teamA=[]; teamB=[]; chooser=null; fofChoice=null; lockSpin(false);
      wheelIds=[...selectedIds]; nextTeam='A'; setFoFUI(false); modeState.textContent='';
      TRACKED_GAMES=[]; teamANameVal=teamAName.value||'Team A'; teamBNameVal=teamBName.value||'Team B';
      renderGameTracker(); renderScore();
      syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState();
    });
    document.getElementById('clearTeamsBtn').addEventListener('click',()=>{
      teamA=[]; teamB=[]; chooser=null; fofChoice=null; lockSpin(false); nextTeam='A';
      syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState();
    });
    document.getElementById('newGameBtn').addEventListener('click',()=>{
      if(confirm('Start a NEW GAME? This clears teams & scores (keeps players).')){
        resetRotor(); teamA=[]; teamB=[]; chooser=null; fofChoice=null; lockSpin(false);
        mode='normal'; nextTeam='A'; wheelIds=[...selectedIds]; setFoFUI(false); modeState.textContent='';
        TRACKED_GAMES=[]; teamANameVal=teamAName.value||'Team A'; teamBNameVal=teamBName.value||'Team B';
        renderGameTracker(); renderScore();
        syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState();
      }
    });
    modeNormal.addEventListener('click',()=>{ mode='normal'; modeState.textContent=''; setFoFUI(false); lockSpin(false); modeFoF.classList.add('secondary'); modeNormal.classList.remove('secondary'); saveState(); });
    modeFoF.addEventListener('click',()=>{ mode='fof'; modeState.textContent='Friend or Foe enabled'; modeFoF.classList.remove('secondary'); modeNormal.classList.add('secondary'); saveState(); });
    formatSel.addEventListener('change',()=>{ teamA=[]; teamB=[]; nextTeam='A'; syncWheelFromSelected(); drawWheel(); updateMatchupUI(); saveState(); });

    teamAName.addEventListener('input',()=>{ teamANameVal=teamAName.value||'Team A'; document.getElementById('sbA').textContent=teamANameVal; renderScore(); renderGameTracker(); saveState(); });
    teamBName.addEventListener('input',()=>{ teamBNameVal=teamBName.value||'Team B'; document.getElementById('sbB').textContent=teamBNameVal; renderScore(); renderGameTracker(); saveState(); });

    /* ---- Player Panel ---- */
    const PlayerPanel=(()=>{
      const el=document.createElement('div');
      el.className='player-panel';
      el.innerHTML=`
        <div class="pp-head">
          <div class="pp-photo" id="ppPhoto"></div>
          <div><div class="pp-name" id="ppName"></div><div class="pp-sub" id="ppSub">Click a player to edit</div></div>
          <button class="pp-close" id="ppClose" title="Close">Ã—</button>
        </div>
        <div class="pp-controls">
          <div class="pp-label">Color</div>
          <input type="color" id="ppColor" value="#6ee7b7" />
        </div>`;
      document.body.appendChild(el);
      const photoEl=el.querySelector('#ppPhoto'); const nameEl=el.querySelector('#ppName'); const colorEl=el.querySelector('#ppColor'); const closeEl=el.querySelector('#ppClose');
      let currentPlayer=null;
      function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
      function positionNear(anchor){
        const rect=anchor.getBoundingClientRect(); const sx=window.scrollX||window.pageXOffset; const sy=window.scrollY||window.pageYOffset;
        const desiredX=rect.right+12+sx; const desiredY=rect.top+sy-8;
        const panelW=el.offsetWidth||600; const panelH=el.offsetHeight||220;
        const maxX=sx+document.documentElement.clientWidth-panelW-12; const maxY=sy+document.documentElement.clientHeight-panelH-12;
        let x=desiredX; if(x>maxX) x=rect.left+sx-panelW-12;
        const y=clamp(desiredY, sy+12, maxY);
        el.style.left=x+'px'; el.style.top=y+'px';
      }
     function positionNear(anchor){
  const rect = anchor.getBoundingClientRect();   // viewport rect (no scroll)
  const vw = document.documentElement.clientWidth;
  const vh = document.documentElement.clientHeight;

  const desiredX = rect.right + 12;              // to the right of the card
  const desiredY = rect.top - 8;                 // slightly up

  const panelW = el.offsetWidth  || 600;
  const panelH = el.offsetHeight || 220;

  const maxX = vw - panelW - 12;
  const maxY = vh - panelH - 12;

  // if it doesn't fit on the right, flip to the left
  let x = desiredX > maxX ? rect.left - panelW - 12 : desiredX;
  x = Math.max(12, Math.min(x, maxX));
  const y = Math.max(12, Math.min(desiredY, maxY));

  el.style.left = x + 'px';
  el.style.top  = y + 'px';
}

      function close(){ el.classList.remove('show'); currentPlayer=null; }
      colorEl.addEventListener('input',()=>{ if(!currentPlayer) return; currentPlayer.color=colorEl.value; saveState(); drawWheel(); updateMatchupUI(); renderRoster(); });
      closeEl.addEventListener('click',close);
      document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && el.classList.contains('show')) close(); });
      document.addEventListener('click',(e)=>{ if(!el.classList.contains('show')) return; if(!el.contains(e.target) && !e.target.closest('.person')) close(); });
      window.addEventListener('resize',()=>{ if(el.classList.contains('show')) close(); });
      return { open, close };
    })();

    /* ---- Init ---- */
    renderRoster();
    syncWheelFromSelected();
    sizeWheel();
    renderGames();

    teamAName.value = teamANameVal || 'Team A';
    teamBName.value = teamBNameVal || 'Team B';
    renderGameTracker();
    renderScore();
    formatSel.value = savedFormat || '2v2';
    updateMatchupUI();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const url = './sw.js?v=3'; // cache-bust
        navigator.serviceWorker.register(url).catch(err => console.warn('SW registration failed', err));
      });
    }
  </script>
</body>
</html>
